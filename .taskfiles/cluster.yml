---
version: "3"

vars:
  K3S_PRIMARY_MASTER_NODE_USERNAME: "ubuntu"
  K3S_PRIMARY_MASTER_NODE_ADDR: "10.10.0.10"
  K3S_LB_ADDR: "10.10.5.5"

tasks:
  kubeconfig:
    desc: Remotely fetch kubeconfig from k3s
    cmds:
      - rsync --verbose --progress --partial --rsync-path="sudo rsync" {{.K3S_PRIMARY_MASTER_NODE_USERNAME}}@{{.K3S_PRIMARY_MASTER_NODE_ADDR}}:/etc/rancher/k3s/k3s.yaml ./kubeconfig
      - sed -i '' 's/127.0.0.1/{{.K3S_LB_ADDR}}/g' ./kubeconfig
      - chmod go-r kubeconfig
    silent: true

  restart-pods:
    desc: Exec into the Rook Ceph toolbox
    cmds:
      - kubectl rollout restart deploy -n kube-system
      - kubectl rollout restart ds -n kube-system
      - kubectl rollout restart ds -n openebs
      - kubectl rollout restart statefulset -n openebs
      - kubectl rollout restart deploy -n minio
      - kubectl rollout restart deploy -n networking
      - kubectl rollout restart statefulset -n databases
      - kubectl rollout restart statefulset -n monitoring
      - kubectl rollout restart ds -n monitoring
      - kubectl rollout restart deploy -n monitoring
      - kubectl rollout restart deploy -n velero
      - kubectl rollout restart ds -n velero
      - kubectl rollout restart deploy -n home
      - kubectl rollout restart deploy -n system-upgrade
      - kubectl rollout restart deploy -n media
      - kubectl rollout restart deploy -n security
      - kubectl rollout restart deploy -n flux-system
      - kubectl rollout restart deploy -n discord
    slient: true

  pause:
    desc: Pause all Helm Releases that rely on ZFS storage
    cmds:
      - flux suspend ks apps
      - flux suspend hr -n minio minio
      - kubectl scale -n minio deploy/minio --replicas 0
      - flux suspend hr -n databases postgresql
      - kubectl scale -n databases statefulset/postgresql-postgresql --replicas 0
      - flux suspend hr -n databases redis
      - kubectl scale -n databases statefulset/redis-master --replicas 0
      - flux suspend hr -n home homebridge
      - kubectl scale -n home deploy/homebridge --replicas 0
      - flux suspend hr -n home hajimari
      - kubectl scale -n home deploy/hajimari --replicas 0
      - flux suspend hr -n media lidarr
      - kubectl scale -n media deploy/lidarr --replicas 0
      - flux suspend hr -n media plex
      - kubectl scale -n media deploy/plex --replicas 0
      - flux suspend hr -n media qbittorrent
      - kubectl scale -n media deploy/qbittorrent --replicas 0
      - flux suspend hr -n media radarr
      - kubectl scale -n media deploy/radarr --replicas 0
      - flux suspend hr -n media prowlarr
      - kubectl scale -n media deploy/prowlarr --replicas 0
      - flux suspend hr -n media sonarr
      - kubectl scale -n media deploy/sonarr --replicas 0
      - flux suspend hr -n media overseerr
      - kubectl scale -n media deploy/overseerr --replicas 0
      - flux suspend hr -n media tautulli
      - kubectl scale -n media deploy/tautulli --replicas 0
      - flux suspend hr -n monitoring loki
      - kubectl scale -n monitoring statefulset/loki --replicas 0
      - flux suspend hr -n monitoring thanos
      - kubectl scale -n monitoring deploy/thanos-query --replicas 0
      - kubectl scale -n monitoring deploy/thanos-bucketweb --replicas 0
      - kubectl scale -n monitoring deploy/thanos-compactor --replicas 0
      - kubectl scale -n monitoring statefulset/thanos-storegateway --replicas 0
      - flux suspend hr -n monitoring kube-prometheus-stack
      - kubectl scale -n monitoring statefulset/alertmanager-prometheus-alertmanager --replicas 0
      - kubectl scale -n monitoring statefulset/prometheus-prometheus-prometheus --replicas 0
      - kubectl scale -n monitoring deploy/prometheus-operator --replicas 0
      - flux suspend hr -n security authentik
      - kubectl scale -n security deploy/authentik-server --replicas 0
      - kubectl scale -n security deploy/authentik-worker --replicas 0
  resume:
    desc: Resume all Helm Releases that rely on ZFS storage
    cmds:
      - flux resume ks apps
      - flux resume hr -n minio minio
      - flux resume hr -n databases postgresql
      - flux resume hr -n databases redis
      - flux resume hr -n home homebridge
      - flux resume hr -n home hajimari
      - flux resume hr -n monitoring loki
      - flux resume hr -n monitoring kube-prometheus-stack
      - flux resume hr -n monitoring thanos
      - flux resume hr -n media lidarr
      - flux resume hr -n media plex
      - flux resume hr -n media qbittorrent
      - flux resume hr -n media radarr
      - flux resume hr -n media prowlarr
      - flux resume hr -n media sonarr
      - flux resume hr -n media overseerr
      - flux resume hr -n media tautulli
      - flux resume hr -n security authentik
