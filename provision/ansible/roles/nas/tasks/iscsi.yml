---
- name: ubuntu | installing iscsitarget (if enabled)
  apt:
    name:
      - iscsitarget
      - iscsitarget-dkms
    state: present
  when: >
        zfs_enable_iscsi is defined and
        zfs_enable_iscsi

- name: ubuntu | un-installing iscsitarget (if not enabled)
  apt:
    name:
      - iscsitarget
      - iscsitarget-dkms
    state: absent
  when: >
        zfs_enable_iscsi is defined and
        not zfs_enable_iscsi

- name: ubuntu | configuring iscsitarget service
  template:
    src: etc/default/iscsitarget.j2
    dest: /etc/default/iscsitarget
    owner: root
    group: root
    mode: 0644
  notify:
    - restart iscsitarget
  when: >
        zfs_enable_iscsi is defined and
        zfs_enable_iscsi

- name: manage_zfs | configuring iscsi devices
  template:
    src: etc/iet/ietd.conf.j2
    dest: /etc/iet/ietd.conf
    owner: root
    group: root
    mode: 0600
  notify:
    - restart iscsitarget
  when: >
        zfs_enable_iscsi is defined and
        zfs_enable_iscsi

- name: manage_zfs | configuring iscsi device access
  template:
    src: etc/iet/initiators.allow.j2
    dest: /etc/iet/initiators.allow
    owner: root
    group: root
    mode: 0644
  notify:
    - restart iscsitarget
  when: >
        zfs_enable_iscsi is defined and
        zfs_enable_iscsi

- name: manage_zfs | configuring iscsi targets access
  template:
    src: etc/iet/targets.allow.j2
    dest: /etc/iet/targets.allow
    owner: root
    group: root
    mode: 0644
  notify:
    - restart iscsitarget
  when: >
        zfs_enable_iscsi is defined and
        zfs_enable_iscsi