---
- name: manage_zfs | managing filesystems
  zfs:
    name: "{{ item.pool }}/{{ item.name }}"
    extra_zfs_properties:
      atime: "{{ item.atime|default(omit) }}"
      compression: "{{ item.compression|default(omit) }}"
      dedup: "{{ item.dedup|default(omit) }}"
      logbias: "{{ item.logbias|default(omit) }}"
      mountpoint: "{{ item.mountpoint|default(omit) }}"
      primarycache: "{{ item.primarycache|default(omit) }}"
      quota: "{{ item.quota|default(omit) }}"
      recordsize: "{{ item.recordsize|default(omit) }}"
      sharenfs: "{{ item.sharenfs|default(omit) }}"
      sync: "{{ item.sync|default(omit) }}"
      snapdev: "{{ item.snapdev|default('hidden')}}"
      snapdir: "{{ item.snapdir|default('hidden')}}"
    state: "{{ item.state }}"
  with_items: "{{ zfs_filesystems }}"
  when: zfs_create_filesystems

- name: manage_zfs | managing volumes
  zfs:
    name: "{{ item.pool }}/{{ item.name }}"
    extra_zfs_properties:
      compression: "{{ item.compression|default(omit) }}"
      dedup: "{{ item.dedup|default(omit) }}"
      quota: "{{ item.quota|default(omit) }}"
      primarycache: "{{ item.primarycache|default(omit) }}"
      recordsize: "{{ item.recordsize|default(omit) }}"
  #    shareiscsi: "{{ item.shareiscsi|default(omit) }}"
      sync: "{{ item.sync|default(omit) }}"
      logbias: "{{ item.logbias|default(omit) }}"
      volsize: "{{ item.volsize|default(omit) }}"
    state: "{{ item.state }}"
  notify:
    - restart iscsitarget
  with_items: "{{ zfs_volumes }}"
  when: zfs_create_volumes

- name: manage_zfs | Setting ZFS Filesystem Permissions
  file:
    path: "{{ item.mountpoint }}"
    mode: "{{ item.mode|default(omit) }}"
    owner: "{{ item.owner|default(omit) }}"
    group: "{{ item.group|default(omit) }}"
  with_items: "{{ zfs_filesystems }}"
  when: zfs_manage_filesystem_permissions
